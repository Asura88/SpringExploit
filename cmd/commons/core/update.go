package core

import (
	log "github.com/sirupsen/logrus"
	"github.com/tj/go-update"
	"github.com/tj/go-update/progress"
	githubUpdateStore "github.com/tj/go-update/stores/github"
	"runtime"
	"strings"
)

const (
	Owner = "SummerSec"
	Repo  = "SpringExploit"
)

func selfUpdate() {
	var command string
	switch runtime.GOOS {
	case "windows":
		command = Repo + ".exe"
	default:
		command = Repo
	}
	m := &update.Manager{
		Command: command,
		Store: &githubUpdateStore.Store{
			Owner:   Owner,
			Repo:    Repo,
			Version: version,
		},
	}

	releases, err := m.LatestReleases()
	if err != nil {
		log.Error("Failed to get releases", err)
		return
	}
	if len(releases) == 0 {
		log.Info("No updates available")
		return
	}
	latest := releases[0]
	var currentOS string
	switch runtime.GOOS {
	case "darwin":
		currentOS = "macOS"
	default:
		currentOS = runtime.GOOS
	}
	final := latest.FindZip(currentOS, runtime.GOARCH)
	if final == nil {
		log.Error("No update available for", currentOS, "and", runtime.GOARCH)
	}
	tarball, err := final.DownloadProxy(progress.Reader)
	if err != nil {
		log.Error("could not install latest release ", err)
		return
	}
	if err := m.Install(tarball); err != nil {
		log.Error("could not install latest release", err)
		return
	}

	log.Infof("Successfully Updated to %s Version %s", Repo, latest.Version)

}

// 获取最新版本
func getLatestVersion() {
	log.Info("Crrunent Version: ", version)
	latestverion := getLatestVersionFromGithub()
	log.Infof("Latest Version: %s", latestverion)
	if strings.Compare(latestverion, version) > 0 {
		log.Info("Use Command SpringExploit -update to update to latest version ")
	}

}

// 获取最新版本从github
func getLatestVersionFromGithub() string {
	m := &update.Manager{
		Store: &githubUpdateStore.Store{
			Owner:   Owner,
			Repo:    Repo,
			Version: version,
		},
	}
	releases, err := m.LatestReleases()
	if err != nil {
		log.Error("Failed to get releases", err)
		return ""
	}
	latest := releases[0]

	return latest.Version
}
