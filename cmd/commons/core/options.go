package core

import (
	"flag"
	"github.com/SummerSec/SpringExploit/cmd/logs"
	log "github.com/sirupsen/logrus"
)

type Options struct {
	// 日志级别
	Mode int
	// file to read
	File string
	// 传入的url
	Url string
	// 设置超时时间
	Timeout int

	// 代理设置
	Proxy string

	// 版本号
	Version bool
	// 是否输出详细信息
	Verbose bool
	// 线程数量
	Thread int
	// 日志输出文件
	LogFile string
	// 重复请求次数
	Retry int

	// 保存结果
	Out string

	// pocs 选择特定的poc
	Pocs string
	// ip 段
	IP string
}

func (o Options) toString() interface{} {

	return o
}

func ParseOptions() *Options {
	options := &Options{}
	flag.IntVar(&options.Mode, "m", 0, "debug mode off (debug mode = 1) default mode = 0")
	flag.IntVar(&options.Thread, "t", 1, "threads number ")
	flag.StringVar(&options.File, "f", "", "file to read example: -file=test.txt  http(s)://host:port/ (notes: The last line must be empty)")
	flag.StringVar(&options.Url, "u", "", "url to read example: -url=http://www.baidu.com:80/")
	flag.StringVar(&options.Proxy, "proxy", "", "proxy example: -proxy=http(socks5)://127.0.0.1:8080 ")
	flag.BoolVar(&options.Version, "version", false, "show version")
	flag.BoolVar(&options.Verbose, "verbose", false, "show verbose")
	flag.StringVar(&options.LogFile, "log", "", "log file example: -log=/logs/logs.txt")
	flag.IntVar(&options.Retry, "retry", 3, "repeat request times")
	//flag.StringVar(&options.IP, "i", "", "ip segment example: -ip=192.168.0.1/24 ")
	flag.IntVar(&options.Timeout, "timeout", 10, "timeout")
	flag.StringVar(&options.Out, "o", "result.txt", "out file example: -o=result.txt default result.txt")
	flag.StringVar(&options.Pocs, "p", "", "pocs example: -p=CVE202222947,CVE202122963,poc3")
	flag.StringVar(&options.IP, "i", "", "ip segment example: -i=192.168.1.1/32")
	flag.Parse()

	// TODO 修改版本号
	v := "0.0.6"

	ShowBanner(v)

	if options.Version {
		//ShowBanner(v)
	} else if url := options.Url; url != "" {
		options.Thread = 1
		options.File = ""
		//ShowBanner(v)
	} else if options.File != "" {
		options.Url = ""
		//ShowBanner(v)
	} else if options.IP != "" {
		options.File = ""
		options.Url = ""
	} else {
		//ShowBanner(v)
		flag.PrintDefaults()
	}
	showVerbose(options)
	logs.SaveLogs(options.LogFile)

	return options

}

func showVerbose(options *Options) {
	if !options.Verbose {
		switch options.Mode {
		case 1:
			log.SetLevel(log.DebugLevel)
		case 2:
			log.SetLevel(log.FatalLevel)
		case 3:
			log.SetLevel(log.ErrorLevel)
		case 4:
			log.SetLevel(log.WarnLevel)
		case 5:
			log.SetLevel(log.InfoLevel)
		case 6:
			log.SetLevel(log.PanicLevel)
		case 7:
			log.SetLevel(log.TraceLevel)
		default:
			log.SetLevel(log.InfoLevel)
			//log.SetLevel(log.DebugLevel)
		}
	} else {
		log.SetLevel(log.DebugLevel)
	}

}
