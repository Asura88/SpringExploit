package core

import (
	"encoding/json"
	"github.com/SummerSec/SpringExploit/cmd/commons/utils"
	"github.com/fatih/structs"
	log "github.com/sirupsen/logrus"
)

type Runner struct {
	options *Options
}

func NewRunner(options *Options) (*Runner, error) {
	r := Runner{options: options}
	mops := structs.Map(&r.options)
	data, _ := json.Marshal(mops)
	log.Info("Runner created")
	log.Debug(mops)
	log.Debug("Runner options: ", string(data))
	return &r, nil

}

func (r *Runner) Run() {
	log.Info("Runner Running")
	f := r.options.File
	var urls []string
	if f == "" {
		urls = append(urls, r.options.Url)
	} else {
		urls, _ = utils.ReadFile(r.options.File)
	}
	var i = 0
	k := r.options.Thread
	for i < len(urls) {
		for t := 0; t < k; t++ {
			if urls[i] != "" {
				go Start(urls[i]) // Start 3 goroutines
				i++
			} else {
				break
			}
		}
	}

}

func Start(url string) {
	log.Info("Runner started")
	log.Infoln("testing URL: ", url)

}
