package utils

import (
	"github.com/imroc/req/v3"
	log "github.com/sirupsen/logrus"
	"time"
)

func InIt(mode int, timeout int, proxy string, retry int, h1 bool) (client *req.Client) {
	log.Debugf("init httpclient")
	client = req.NewClient()
	if mode != 0 {
		client.EnableDumpAll().EnableDebugLog()
	}

	// TODO client.DisableAutoReadResponse() 不能开启DisableAutoReadResponse 不然CVE-2022-1388 漏洞无法验证
	if h1 {
		// TODO 强制开启 EnableForceHTTP1 CVE-2022-1388 漏洞设置http代理的情况下必须强制开启HTTP1 其他情况框架会自动判断使用什么版本http协议
		client.EnableForceHTTP1()
	}

	client.SetLogger(log.StandardLogger())
	// 设置超时时间
	client.SetTimeout(time.Duration(timeout) * time.Second)
	client.SetCommonRetryCount(retry)
	client.EnableInsecureSkipVerify()
	// 设置代理
	f := IsProxyUrl(proxy)
	if f {
		proxy = GetProxyUrl(proxy)
		client.SetProxyURL(proxy)
	} else if proxy == "" {

	} else {
		log.Error("proxy:	" + proxy + "	is not a valid url")
		return nil
	}
	return client
}

func Send(hashmap map[string]interface{}) (resp *req.Response) {
	log.Debugln("send requesting")
	method := hashmap["method"].(string)
	url := hashmap["url"].(string)
	proxy := hashmap["proxy"].(string)
	retry := hashmap["retry"].(int)
	timeout := hashmap["timeout"].(int)
	mode := hashmap["mode"].(int)
	headers := hashmap["headers"].(map[string]string)
	body := hashmap["body"]
	h1 := hashmap["h1"].(bool)

	client := InIt(mode, timeout, proxy, retry, h1)

	reqt := client.R().EnableDump()
	reqs := SetRequest(reqt, headers, body.(string))
	resp, errs := reqs.Send(method, url)
	if resp == nil || errs != nil {
		log.Debug("requesting error: " + errs.Error())
		return resp
	}
	log.Debugln("send request success")
	return resp
}
